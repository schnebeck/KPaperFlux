
import sys
import unittest
from PyQt6.QtWidgets import QApplication
from PyQt6.QtCore import Qt, QPoint

# Hardcode project root
import os
project_root = os.path.abspath(os.path.join(os.path.dirname(__file__), ".."))
if project_root not in sys.path:
    sys.path.insert(0, project_root)

from gui.widgets.splitter_strip import SplitterStripWidget, PageThumbnailWidget, SplitDividerWidget, DragPlaceholderWidget

class TestBoundaryEnforcement(unittest.TestCase):
    @classmethod
    def setUpClass(cls):
        cls.app = QApplication.instance() or QApplication(sys.argv)

    def setUp(self):
        self.strip = SplitterStripWidget()
        # Mock pages
        self.pages = [
            {"page": 1, "rotation": 0, "file_uuid": "f1"},
            {"page": 2, "rotation": 0, "file_uuid": "f1"},
            {"page": 3, "rotation": 0, "file_uuid": "f1"}
        ]
        self.strip._populate_strip(self.pages)
        # Sequence in layout should be:
        # 0: Thumbnail 1
        # 1: Divider (inactive)
        # 2: Thumbnail 2
        # 3: Divider (inactive)
        # 4: Thumbnail 3

    def test_one_page_doc_locking(self):
        print("\nChecking One-Page Doc Locking...")
        
        # 1. Setup Active Splits to isolate Page 2
        # Layout: [T1, D1(active), T2, D2(active), T3]
        div1 = self.strip.content_layout.itemAt(1).widget()
        div2 = self.strip.content_layout.itemAt(3).widget()
        self.assertTrue(isinstance(div1, SplitDividerWidget))
        self.assertTrue(isinstance(div2, SplitDividerWidget))
        
        div1.set_active(True)
        div2.set_active(True)
        
        # 2. Simulate Drag Start on Page 2
        thumb2 = self.strip.content_layout.itemAt(2).widget()
        self.strip.selected_widgets = [thumb2]
        
        # Simulate drag Enter (creates placeholder)
        # We manually trigger what on_drag_started + dragEnterEvent would do
        self.strip.drag_placeholder_width = thumb2.width()
        self.strip.drag_placeholder = DragPlaceholderWidget(self.strip.drag_placeholder_width, self.strip)
        self.strip.content_layout.insertWidget(2, self.strip.drag_placeholder)
        thumb2.hide()
        
        # Layout now:
        # 0: T1
        # 1: D1 (Active)
        # 2: Gap (Placeholder)
        # 3: T2 (Hidden)  <-- Wait, insertWidget at 2 shifted T2 to 3!
        # 4: D2 (Active)
        # 5: T3
        
        gap_idx = self.strip.content_layout.indexOf(self.strip.drag_placeholder)
        self.assertEqual(gap_idx, 2)
        
        # Check Neighbors
        d1 = self.strip.content_layout.itemAt(1).widget()
        d2 = self.strip.content_layout.itemAt(4).widget()
        self.assertTrue(d1.is_active)
        self.assertTrue(d2.is_active)
        
        # 3. Test Swipe Right attempt
        # We need to simulate a local_pos that is deep into T3 (index 5)
        t3 = self.strip.content_layout.itemAt(5).widget()
        t3_geo = t3.geometry()
        target_pos = t3_geo.center()
        
        idx, neighbor = self.strip._calculate_target_index_stable(target_pos)
        
        print(f"Swap attempt Right: target_idx={idx}, neighbor={neighbor}")
        self.assertIsNone(idx, "Boundary wall (active split) failed to block swap to the right!")
        
        # 4. Test Swipe Left attempt
        t1 = self.strip.content_layout.itemAt(0).widget()
        t1_geo = t1.geometry()
        target_pos = t1_geo.center()
        
        idx, neighbor = self.strip._calculate_target_index_stable(target_pos)
        
        print(f"Swap attempt Left: target_idx={idx}, neighbor={neighbor}")
        self.assertIsNone(idx, "Boundary wall (active split) failed to block swap to the left!")

        print("Boundary Enforcement Test PASSED")

if __name__ == "__main__":
    unittest.main()
