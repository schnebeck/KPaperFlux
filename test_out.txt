============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-9.0.2, pluggy-1.6.0
PyQt6 6.10.2 -- Qt runtime 6.10.2 -- Qt compiled 6.10.0
rootdir: /home/schnebeck/Dokumente/Projects/KPaperFlux
configfile: pytest.ini
plugins: dash-3.2.0, qt-4.5.0, anyio-4.9.0, typeguard-4.1.5, hypothesis-6.98.15
collected 4 items

../../../Dokumente/Projects/KPaperFlux/tests/gui/test_document_list.py [DEBUG] Standard View returned 2 documents.
[DEBUG] refresh_list: Initial population (2 documents).
[DEBUG] Standard View returned 2 documents.
F[DEBUG] Standard View returned 0 documents.
[DEBUG] refresh_list: Initial population (0 documents).
[DEBUG] Standard View returned 0 documents.
.[DEBUG] Standard View returned 1 documents.
[DEBUG] refresh_list: Initial population (1 documents).
[DEBUG] Standard View returned 1 documents.
.[DEBUG] Standard View returned 1 documents.
[DEBUG] refresh_list: Initial population (1 documents).
[DEBUG] Standard View returned 1 documents.
.

=================================== FAILURES ===================================
________________________ test_document_list_population _________________________

qtbot = <pytestqt.qtbot.QtBot object at 0x7738c6c537a0>
mock_db = <MagicMock id='131086045498496'>

    def test_document_list_population(qtbot, mock_db):
        """Test that the list widget populates correct data from DB."""
        # Data Setup - Using a structure similar to what comes from the DB
        docs = [
            Document(
                uuid="uuid-1",
                original_filename="invoice.pdf",
                semantic_data=SemanticExtraction(**{
                    "meta_header": {
                        "sender": {"name": "Amazon"},
                        "doc_date": "2023-01-01"
                    },
                    "bodies": {"finance_body": {"total_gross": 15.99}}
                })
            ),
            Document(uuid="uuid-2", original_filename="contract.pdf", type_tags=["Vertrag"])
        ]
    
        mock_db.get_all_documents.return_value = docs
        mock_db.get_all_entities_view.return_value = docs
    
        # Init Widget
        widget = DocumentListWidget(db_manager=mock_db)
        # Explicitly set dynamic columns for testing (since they are no longer hardcoded by default)
        widget.dynamic_columns = ["doc_date", "sender_name", "total_amount"]
        widget.update_headers()
    
        qtbot.addWidget(widget)
        widget.refresh_list()
    
        # Verify Rows
        assert widget.rowCount() == 2
    
        # Find the item for uuid-1
        item = None
        for i in range(widget.rowCount()):
            if widget.item(i).text(1) == "uuid-1":
                item = widget.item(i)
                break
    
        assert item is not None, "Document with uuid-1 not found in list."
    
        header_item = widget.tree.headerItem()
        header_labels = [header_item.text(i) for i in range(widget.tree.columnCount())]
    
        def get_col(label):
            return header_labels.index(label)
    
        # Fixed Columns
        assert item.text(get_col("Entity ID")) == "uuid-1"
        assert item.text(get_col("Filename")) == "invoice.pdf"
    
        # Dynamic Semantic Columns
        assert item.text(get_col("Date")) == "2023-01-01"
>       assert item.text(get_col("Sender")) == "Amazon"
E       AssertionError: assert '' == 'Amazon'
E         
E         - Amazon

../../../Dokumente/Projects/KPaperFlux/tests/gui/test_document_list.py:67: AssertionError
=========================== short test summary info ============================
FAILED ../../../Dokumente/Projects/KPaperFlux/tests/gui/test_document_list.py::test_document_list_population
========================= 1 failed, 3 passed in 0.98s ==========================
